<link rel="import" href="../bower_components/polymer/polymer.html">

<!--
The `<io-logo>` provides a  material design animation loading screen which transitions
differently based on the type of page. For the homepage, the logo
transitions from the center of the screen to its ending position in the masthead.
For all other pages, the logo only fades out after its animation is done. This
is because there is no destination position to transition to.

`<io-logo>` is expected to be within a container element. The container should
expand to the full viewport width/height and vertically/horizontally center
its children using CSS flebox (or similar). The `<io-logo>` element doesn't
provide this feature by default so styling can be applied on the outside by
the main page, before Polymer is ready and the element is upgraded.

## Partner elements

`<io-logo>` queries for and transitions elements outside itself.

The container element should  contain a child element with the
`iologobackground` attribute. This element should expand to its parent's
width/height using CSS and have a background color the same as the masthead.

`<io-logo>` determines the masthead element on the page by querying for an
element with the `.masthead` class.

`<io-logo>` determines homepage I/O logo element by querying for an element
with the attribute `iologodestination`.

#### Example

    <div class="masthead">
      ...
      <div iologodestination></div>
    </div>

    <div class="io-logo-container">
      <io-logo width="312" height="165" class="bg-medium-grey"></io-logo>
      <div class="bg-medium-grey" iologobackground></div>
    </div>

@element io-logo
-->
<polymer-element name="io-logo" attributes="height width year page">
  <template>
    <link rel="stylesheet" href="io-logo.css">
    <div layout horizontal style="height:100%">
      <div id="i" class="letter" flex></div>
      <div id="slash" class="letter"></div>
      <div id="o" class="o letter" style="max-width:[[height]]px" flex layout vertical center-center>
        <div id="o2" class="o" style="height:{{height - 20}}px;width:{{height - 20}}px" layout vertical center-center>
          <h2 id="year">[[year]]</h2>
        </div>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    /**
     * The two-digit year to display inside the "O".
     *
     * @attribute width
     * @type number
     * @default the current year (e.g. 15)
     */
    year: (new Date()).getFullYear() % 2000,

    /**
     * Height of the logo in pixels.
     *
     * @attribute height
     * @type number|string
     * @default 165
     */
    height: 165,

    /**
     * Width of the logo in pixels.
     *
     * @attribute width
     * @type number|string
     * @default 213
     */
    width: 312,

    /**
     * The page that was loaded at pageload time.
     *
     * @attribute page
     * @type string
     * @default null
     */
    page: null,

    /**
     * The number of milliseconds the center of the "O" shows after it has grown.
     *
     * @property SHOW_FOR
     * @type number
     * @default 100
     */
    SHOW_FOR: 100,

    /**
     * The number of milliseconds before the "O" starts to grow.
     *
     * @property START_DELAY
     * @type number
     * @default 300
     */
    START_DELAY: 300,

    /**
     * The left/top of the destination node will be used to calculate the final
     * left/top of the logo at the end of its animation.
     *
     * @property destination
     * @type Element
     * @default null
     */
    destination: null,

    /**
     * The site's container masthead element.
     *
     * @property masthead
     * @type Element
     * @default null
     */
    masthead: null,

    /**
     * The colored background element that will be scaled down to the masthead size.
     *
     * @property backgroundTarget
     * @type Element
     * @default null
     */
    backgroundTarget: null,

    ready: function() {
      this.heightChanged();
      this.widthChanged();
    },

    attached: function() {
      this.start();
    },

    heightChanged: function() {
      this.style.height = parseInt(this.height) + 'px';
    },

    widthChanged: function() {
      this.style.width = parseInt(this.width) + 'px';
    },

    /**
     * Starts the loading animation sequence.
     * @method start
     */
    start: function() {
      var sequence = new AnimationSequence([
        new Animation(this.$.o2, [
          {transform: 'scale(0)'},
          {transform: 'scale(1)'}
        ], {
          delay: this.START_DELAY,
          duration: 400,
          easing: 'cubic-bezier(0,0,0.21,1)',
          fill: 'forwards'
        })
      ]);

      var iteration = 0;

      var player = document.timeline.play(sequence);

      // TODO(ericbidelman): this should be possible with creating the sequence
      // direction: alternate and introducing a delay between reversing the
      // animation. Inquire with WA folks.
      // https://github.com/GoogleChrome/ioweb2015/issues/168
      player.onfinish = function(e) {
        iteration++;
        if (iteration >= 2) {
          player.cancel();
          this.moveLogo();
          return;
        }

        this.async(function() {
          player.reverse();
        }, null, this.SHOW_FOR);
      }.bind(this);
    },

    moveLogo: function() {
      this.backgroundTarget = this.parentElement.querySelector('[iologobackground]');
      this.masthead = document.querySelector('.masthead');
      this.destination = document.querySelector('[iologodestination]');

      var current = this.getBoundingClientRect();
      var dest = this.destination.getBoundingClientRect();
      var mast = this.masthead.getBoundingClientRect();

      var containerWidth = document.documentElement.clientWidth;
      var containerHeight = document.documentElement.clientHeight;

      var diffX = dest.left - current.left;
      var diffY = dest.top - current.top;

      // Magic padding/margin offsets to get the I/O logo in its final position.
      if (containerWidth > 769) { // Tablet/desktop
        diffY += 9;
        scale = 0.83;
      } else {
        diffY -= 19;
        scale = 0.58;
      }

      // Ensure masthead is behind top transition up card up and FAB.
      this.parentElement.style.zIndex = 1;

      // Masthead clipping.
      var mastheadClipAnimation = new Animation(this.backgroundTarget, [
        {transform: 'translateY(0)'},
        {transform: 'translateY(-' + Math.max(containerHeight - mast.height, 0) + 'px)'}
      ], {
        duration: 500,
        iterations: 1,
        fill: 'forwards',
        easing: 'cubic-bezier(0,0,0.21,1)'
      });

      if (this.page == 'home') {
        // At the same time, clip masthead background and move I/O logo.
        var animations = new AnimationGroup([
          mastheadClipAnimation,
          // I/O logo movement.
          new Animation(this, [
            {transform: 'none'},
            {transform: 'translate3d(' + diffX + 'px,' + diffY + 'px,0) scale(' + scale + ')'}
          ], {
            duration: 500,
            iterations: 1,
            fill: 'forwards',
            easing: 'cubic-bezier(0,0,0.21,1)'
          })
        ]);
      } else {
        // Fade out I/O logo then clip masthead background.
        var animations = new AnimationSequence([
          // I/O logo fade out.
          new Animation(this, [
            {opacity: 1},
            {opacity: 0}
          ], {
            duration: 300,
            iterations: 1,
            fill: 'forwards',
            easing: 'cubic-bezier(0,0,0.21,1)'
          }),
          mastheadClipAnimation
        ]);
      }

      var player = document.timeline.play(animations);

      player.onfinish = function(e) {
        var el = this.parentElement;
        this.fire('finish');
        el.parentElement.removeChild(el);
      }.bind(this);
    }
  });
  </script>
</polymer-element>
