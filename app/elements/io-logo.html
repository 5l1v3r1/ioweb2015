<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="io-logo" attributes="height width year">
  <template>
    <link rel="stylesheet" href="io-logo.css">
    <div layout horizontal style="height:100%">
      <div id="i" class="letter" flex></div>
      <div id="slash" class="letter"></div>
      <div id="o" class="o letter" style="max-width:[[height]]px" flex layout vertical center-center>
        <div id="o2" class="o" style="height:{{height - 20}}px;width:{{height - 20}}px" layout vertical center-center>
          <h2 id="year">[[year]]</h2>
        </div>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    /**
     * The two-digit year to display inside the "O".
     *
     * @attribute width
     * @type number
     * @default the current year
     */
    year: (new Date()).getYear() - 100,

    /**
     * Height of the logo in pixels.
     *
     * @attribute height
     * @type number
     * @default 165
     */
    height: 165,

    /**
     * Width of the logo in pixels.
     *
     * @attribute width
     * @type number
     * @default 213
     */
    width: 312,

    /**
     * The number of milliseconds the center of the "O" shows after it has grown.
     *
     * @property SHOW_FOR
     * @type number
     * @default 600
     */
    SHOW_FOR: 600,

    /**
     * The number of milliseconds before the "O" starts to grow.
     *
     * @property START_DELAY
     * @type number
     * @default 300
     */
    START_DELAY: 300,

    ready: function() {
      this.heightChanged();
      this.widthChanged();
    },

    domReady: function() {
      this.start();
    },

    heightChanged: function() {
      this.style.height = parseInt(this.height) + 'px';
    },

    widthChanged: function() {
      this.style.width = parseInt(this.width) + 'px';
    },

    /**
     * Starts the loading animation sequence.
     * @method start
     */
    start: function() {
      var GROW_DURATION = 400;

      var sequence = new AnimationSequence([
        new Animation(this.$.o2, [
          {transform: 'scale(0)'},
          {transform: 'scale(1)'}
        ], {
          delay: this.START_DELAY,
          // direction: 'alternate',
          duration: GROW_DURATION,
          // iterations: 1,
          easing: 'cubic-bezier(.72,0,.28,1)', //cubic-bezier(0,0,0.21,1)
          fill: 'forwards'
        })
      ]);

      var iteration = 0;

      var player = document.timeline.play(sequence);

      // TODO(ericbidelman): this should be possible with creating the sequence
      // direction: alternate and introducing a delay between reversing the
      // animation. Inquire with WA folks.
      player.onfinish = function(e) {
        iteration++;
        if (iteration >= 2) {
          player.cancel();
          this.animationDone(e);
          return;
        }

        this.async(function() {
          player.reverse();
        }, null, this.SHOW_FOR);
      }.bind(this);
    },

    animationDone: function(e, detail, sender) {
      var logoContainerCurrent = this.getBoundingClientRect();
      var logoContainerFinal = document.querySelector('.masthead-container .io-logo').getBoundingClientRect();
      var mastHead = document.querySelector('.masthead').getBoundingClientRect();

      var finalX = parseInt(Math.abs(logoContainerCurrent.left - logoContainerFinal.left));
      var finalY = parseInt(Math.abs(logoContainerCurrent.top - logoContainerFinal.top));

      if (logoContainerFinal.left < logoContainerCurrent.left) {
        finalX *= -1;
        finalY = -(finalY - 9);
        scale = 0.83;
      } else {
        // mobile
        finalY = -(finalY + 19);
        scale = 0.58;
      }

      var containerWidth = document.documentElement.clientWidth;
      var containerHeight = document.documentElement.clientHeight;


this.parentElement.style.zIndex = 1;
// this.parentElement.style.background = 'none';

// this.style.transform = 'translate3d(' + finalX + 'px,' + finalY + 'px,0) scale(' + scale + ')';

      var group = new AnimationGroup([
        new Animation(this.parentElement, [
            {clip: 'rect(0, ' + containerWidth + 'px, ' + containerHeight + 'px, 0)'},
            {clip: 'rect(0, ' + mastHead.width + 'px, ' + mastHead.height + 'px, 0)'},
          ], {
            duration: 300,
            iterations: 1,
            fill: 'forwards',
            easing: 'cubic-bezier(0,0,0.21,1)'
          }
        ),
        // new Animation(this.parentElement, [
        //     {background: 'inherit', height: '100%'},
        //     {background: 'transparent', height: '66vh'}
        //   ], {
        //     duration: 300,
        //     iterations: 1,
        //     fill: 'forwards'
        //   }
        // ),
        new Animation(this, [
            {transform: 'none'},
            {transform: 'translate3d(' + finalX + 'px,' + finalY + 'px,0) scale(' + scale + ')'}
          ], {
            duration: 300,
            iterations: 1,
            fill: 'forwards',
            easing: 'cubic-bezier(0,0,0.21,1)'
          }
        )
      ]);

      var player = document.timeline.play(group);

      player.onfinish = function(e) {
        var el = this.parentElement;
        var callback = function(e) {
          el.removeEventListener('transitionend', callback);
          el.parentElement.removeChild(el);
        };

        el.addEventListener('transitionend', callback);

        el.classList.add('fadeout');
      }.bind(this);
    }
  });
  </script>
</polymer-element>
