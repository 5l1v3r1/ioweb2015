<!--
Copyright 2015 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-media-query/core-media-query.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="social-post.html">

<script src="../scripts/analytics.js"></script>
<script src="../scripts/helper/request.js"></script>

<!--
The `<io-gadget>` element renders a youtube video + social feed.

@element io-gadget
-->
<polymer-element name="io-gadget">
  <template>
    <link rel="stylesheet" href="io-gadget.css">

    <core-media-query query="(min-width:320px) and (max-width:767px)"
                      queryMatches="{{isPhoneSize}}"></core-media-query>

    <div id="livebanner" layout horizontal center end-justified>
      <h4><a href="{{'schedule'}}" target="_blank"
             on-click="{{onOpenSchedule}}">I/O Live schedule</a></h4>
    </div>

    <section id="gadget-content" layout horizontal vertical?="{{isPhoneSize}}" fit>

      <template if="{{!noVideo}}">

        <template if="{{view === VIEWS_.BEFORE}}">
          <div class="preroll" layout vertical center-center auto-vertical flex two>
            <div layout vertical self-start>
              <h1>I/O live</h1>
              <h3>Tune in here on May 28, starting at 9AM PDT.<br>
              Learn more about Google I/O at <a href="https://google.com/io" target="_blank">google.com/io</a>.</h3>
              <h4>#io15</h4>
            </div>
          </div>
        </template>

        <template if="{{view === VIEWS_.BETWEEN}}">
          <div class="preroll" layout vertical center-center auto-vertical flex two>
            <div layout vertical self-start>
              <h1>I/O live</h1>
              <h3>Tune in here again on May 29, starting at 9AM PDT.<br>
              Meanwhile, watch the 2015 keynote and sessions at <a href="{{'videos'}}" target="_blank">events.google.com/io2015/videos</a>.</h3>
              <h4>#io15</h4>
            </div>
          </div>
        </template>

        <template if="{{view === VIEWS_.AFTER}}">
          <div class="preroll" layout vertical center-center auto-vertical flex two>
            <div layout vertical self-start>
              <h1>I/O live</h1>
              <h3>Thanks for another great Google I/O.<br>
              Watch the 2015 keynote and sessions at <a href="{{'videos'}}" target="_blank">events.google.com/io2015/videos</a>.</h3>
              <h4>#io15</h4>
            </div>
          </div>
        </template>

        <template if="{{view === VIEWS_.LIVE}}">

          <div class="card card--livestream" layout vertical auto-vertical flex two>
            <div flex class="card__photo" relative>
              <img src="../images/play-video-button.png"
                   class="play__gbutton play__button--card"
                   title="Start watching" alt="Start watching">

              <google-youtube id="video" height="100%" width="100%" fit
                              videoid="{{selectedVideoId}}" autohide="1"
                              controls="2" modestbranding="1" showinfo="0"
                              iv_load_policy="3" rel="0" autoplay="0"
                              on-google-youtube-ready="{{onVideoReady}}"
                              on-google-youtube-state-change="{{onStateChange}}"></google-youtube>

            </div>
            <div class="card-content card--video-meta" layout horizontal center>
              <div flex>
                <div class="video-title" title="{{videoTitle}}">{{videoTitle}}&nbsp;</div>
                <!-- <div class="video-author">{{videoAuthor}}</div> -->
              </div>
              <div>
                <paper-dropdown-menu label="Switch channel">
                  <paper-dropdown valign="bottom" halign="right" class="dropdown">
                    <core-menu class="menu" valueattr="videoid" selected="{{selectedVideoId}}}">
                      <template repeat="{{video,i in videoIds}}">
                        <template if="{{i === 0}}">
                          <paper-item videoid="{{video}}">Keynote</paper-item>
                        </template>
                        <template if="{{i > 0}}">
                          <paper-item videoid="{{video}}">Channel {{i + 1}}</paper-item>
                        </template>
                      </template>
                    </core-menu>
                  </paper-dropdown>
                </paper-dropdown-menu>
              </div>
            </div>
          </div>

        </template>

      </template>

      <template if="{{!noFeed}}">
        <div id="social-feed" class="card" layout vertical auto-vertical flex>
          <div class="card-content">
            <h3>Google I/O Social Feed</h3>
            <div><a href="https://twitter.com/googledevs" target="_blank">@googledevs</a></div>
          </div>
          <div id="post-container" class="card-content" flex>
            <div layout vertical>
              <template repeat="{{socialPost in socialPosts}}">
                <social-post kind="{{socialPost.kind}}"
                             author="{{socialPost.author}}"
                             url="{{socialPost.url}}"
                             text="{{socialPost.text}}"
                             when="{{socialPost.when}}"
                             hideAuthor>
                </social-post>
              </template>
            </div>
          </div>
        </div>
      </template>

    </section>

    <div id="copyright-text">Video &amp; social announcements &copy; Google</div>

  </template>
  <script>
  (function() {

    var VIEWS_ = {BEFORE: 0, LIVE: 1, BETWEEN: 2, AFTER: 3};

    Polymer({

      publish: {
        /**
         * The selected YouTube video id to play.
         *
         * @attribute videoIds
         * @type array
         * @default []
         */
         videoIds: null,

        /**
         * If true, shows the social feed.
         *
         * @attribute noFeed
         * @type bool
         * @default false
         */
        noFeed: false,

        /**
         * If true, displays the video stream.
         *
         * @attribute noVideo
         * @type bool
         * @default false
         */
        noVideo: false
      },

      /**
       * The selected video from the list of videoIds
       *
       * @property selectedVideoId
       * @type string
       * @default null
       */
      selectedVideoId: null,

      /**
       * The author of the video, as returned by the YT API.
       *
       * @attribute videoAuthor
       * @type string
       * @default ''
       */
      videoAuthor: '',

      /**
       * The title of the video, as returned by the YT API.
       *
       * @attribute videoTitle
       * @type string
       * @default ''
       */
      videoTitle: '',

      /**
       * API endpoint to retrieve social posts from.
       *
       * @property socialPostsEndpoint
       * @type string
       * @default 'api/v1/social'
       */
      socialPostsEndpoint: 'api/v1/social',

      /**
       * Interval (ms) to poll for posts.
       *
       * @property socialPostUpdateInterval
       * @type number
       * @default 30000
       */
      socialPostUpdateInterval: 30000,

      /**
       * The view to show.
       *
       * @property view
       * @type number
       * @default 0
       */
      view: null,

      /**
       * List of API results.
       *
       * @property socialPosts
       * @type array
       * @default []
       */

      updateSocialPostsTimeout_: null,

      wasPaused_: false,

      VIEWS_: VIEWS_,

      created: function() {
        this.socialPosts = [];
        this.videoIds = [];
      },

      ready: function() {
        IOWA.Request.cacheThenNetwork(
            this.socialPostsEndpoint, this.processSocialPosts.bind(this),
            this.processSocialPosts.bind(this));

         // Set a timeout to fetch new posts after 30 seconds.
        this.updateSocialPostsTimeout_ = window.setTimeout(
            this.updateSocialPosts.bind(this), this.socialPostUpdateInterval);

        this.setView();
      },

      videoIdsChanged: function() {
        this.selectedVideoId = this.videoIds[0];
      },

      updateVideoInfo: function() {
        var video = this.$['gadget-content'].querySelector('google-youtube');
        var meta = video.player.getVideoData();
        this.videoTitle = meta.title;
        this.videoAuthor = meta.author;
      },

      onVideoReady: function(e, detail, sender) {
        this.updateVideoInfo();
      },

      onStateChange: function(e, detail) {
        var video = this.$['gadget-content'].querySelector('google-youtube');

        switch (detail.data) {
          case YT.PlayerState.CUED:
            this.wasPaused_ = false;
            video.play();
            break;
          case YT.PlayerState.PAUSED:
            this.wasPaused_ = true;
            break;
          case YT.PlayerState.PLAYING:
            this.updateVideoInfo();
            if (!this.wasPaused_) {
              IOWA.Analytics.trackEvent('gadget', 'video', this.selectedVideoId);
            }
            this.wasPaused_ = false;
            break;
        }
      },

      selectedVideoIdChanged: function(oldVal, newVal) {
        var video = this.$['gadget-content'].querySelector('google-youtube');
        if (video && this.videoIds.indexOf(newVal) !== -1) {
          video.play(); // Start auto-playing video when new one was selected.
        }
      },

      updateSocialPosts: function() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', this.socialPostsEndpoint);
        // The request will be intercepted by the service worker, which will use a network-first
        // policy to ensure that the service worker cache is initially ignored.
        // But if the device is offline, it will return the previously cached content.
        xhr.setRequestHeader('X-Cache-Only', 'false');

        xhr.onload = function() {
          if (xhr.status < 400) {
            this.processSocialPosts(JSON.parse(xhr.response));
            // Schedule another automatic update if we got a successful response back.
            this.updateSocialPostsTimeout_ = window.setTimeout(
                this.updateSocialPosts.bind(this),
                this.socialPostUpdateInterval);
          }
        }.bind(this);

        xhr.send();
      },

      processSocialPosts: function(socialPosts) {
        this.socialPosts = socialPosts;
      },

      onOpenSchedule: function(e, detail, sender) {
        IOWA.Analytics.trackEvent('gadget', 'link', 'open-schedule-link');
      },

      setView: function() {
        var day1Start = new Date('May 28 2015 08:30:00 GMT-0700 (PDT)');
        var day1End = new Date('May 28 2015 17:00:00 GMT-0700 (PDT)');
        var day2Start = new Date('May 29 2015 08:30:00 GMT-0700 (PDT)');
        var day2End = new Date('May 29 2015 17:00:00 GMT-0700 (PDT)');

        var now = new Date();
        var offset = 50;

        if (now < day1Start) {
          this.view = this.VIEWS_.BEFORE;
          var timeout = (day1Start - now) + offset;
          if (timeout > 0) {
            setTimeout(this.setView.bind(this), timeout); // refresh view when I/O starts.
          }
        } else if (now > day1Start && now < day1End ||
                   now > day2Start && now < day2End) {
          this.view = this.VIEWS_.LIVE;
          var timeout = (day2Start - (day1End - now)) + offset;
          if (timeout > 0) {
            setTimeout(this.setView.bind(this), timeout); // refresh view when day 1 ends.
          }
        } else if (now > day1End && now < day2Start) {
          this.view = this.VIEWS_.BETWEEN;
          var timeout = (day2Start - now) + offset;
          if (timeout > 0) {
            setTimeout(this.setView.bind(this), timeout); // refresh view when day2 starts.
          }
        } else if (now > day2End) {
          this.view = this.VIEWS_.AFTER;
          var timeout = (day2End - now) + offset;
          if (timeout > 0) {
            console.log(timeout)
            setTimeout(this.setView.bind(this), timeout); // refresh view when day2 ends.
          }
        }
      }

    });

  })();
  </script>
</polymer-element>
