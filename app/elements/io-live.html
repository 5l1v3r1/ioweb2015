<!--
Copyright 2015 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-animated-pages/transitions/slide-from-right.html">

<link rel="import" href="../bower_components/core-label/core-label.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="io-radio-button.html">

<!--
The `<io-live>` provides the Google I/O live stream experience.

@element io-live
-->
<!--
Fired when the mode changes.

@event io-live-mode
-->
<polymer-element name="io-live">
  <template>
    <link rel="stylesheet" href="io-live.css">

    <div class="bottom__bar" layout horizontal end justified>
      <div>
        <template if="{{mode === _MODES.BEFORE}}">
          <content></content>
        </template>
      </div>

      <paper-fab id="schedfab" icon="picture-in-picture"
                 aria-label="My schedule" title="My schedule" on-tap="{{onFabClick}}"></paper-fab>

      <div id="livewidget" on-transitionend="{{onFabTransition}}">
        <div class="bg-dark-grey" layout vertical>

          <div class="widget-nav" layout horizontal center self-end>
            <paper-icon-button icon="close" on-tap="{{closeFab}}"></paper-icon-button>
          </div>

          <paper-tabs class="white" valueattr="label" selected="{{selectedTab}}">
            <paper-tab label="live" role="">I/O Live</paper-tab>
            <paper-tab label="schedule" role="">Live schedule</paper-tab>
            <paper-tab label="hash" role="">#io15</paper-tab>
          </paper-tabs>

          <core-animated-pages transitions="slide-from-right" selected="{{selectedTab}}" valueattr="label" fit>
            <section label="live" layout vertical>
              <div layout vertical flex>
                <div class="card__photo card__photo--live" flex></div>
                <div class="card">
                  <div class="card-content">Our 8th annual Google I/O developer conference will kick-off with a keynote hosted by our Senior Vice-President of Products, Sundar Pichai.</div>
                </div>
              </div>
            </section>
            <section class="schedule__content" label="schedule" layout vertical>

              <div class="card schedule-rows" layout vertical>
                <template repeat="{{session in sessions | filterLiveSessionsByDay(currentDay)}}">
                  <div class="card-content" hidden?="{{!session.firstOfBlock}}">
                    <h4>{{session.block}}</h4>
                  </div>
                  <div class="schedule-row" layout horizontal>
                    <io-radio-button aria-labelledby="session-{{session.id}}-title" toggles checked?="{{session.saved}}"></io-radio-button>
                    <div layout vertical flex tabindex="0">
                      <span id="session-{{session.id}}-title" class="schedule-title"
                            auto-vertical flex?="{{!isPhoneSize}}" two
                            title="{{session.title}}">
                        {{session.title}}
                      </span>
                      <div class="schedule-speakers">{{session.speakers | speakerIdsToNameString}}</div>
                    </div>
                  </div>
                </template>
              </div>

              <div class="card card__bottom-links">
                <paper-progress indeterminate hidden?="{{!fetchingUserData}}" fit></paper-progress>

                <div class="card-content" layout horizontal justified>
                  <a href="schedule#day{{dayView}}" data-ajax-link data-track-link="live-fullschedule">Full schedule</a>
                  <a href="{{'schedule#myschedule'}}" data-ajax-link data-track-link="live-myschedule">My schedule</a>
                </div>
              </div>

            </section>
            <section label="hash">
              <div layout vertical>hash</div>
            </section>
          </core-animated-pages>

        </div>
      </div>
    </div>

    <div id="livecontainer">

      <template if="{{mode === _MODES.LIVE}}">
        <div class="fullvideo__container" fit>
          <!-- <img src="{{''}}images/home/recap-500@2x.jpg" class="fullvideo_thumbnail" alt="Watch I/O Live" fit> -->
          <google-youtube videoid="ksvdvCDO7pA" height="100%" width="100%" fit
                          autohide="1" controls="2" modestbranding="1" showinfo="0"
                          iv_load_policy="3" rel="0" autoplay="1"></google-youtube>
        </div>
      </template>

      <template if="{{mode === _MODES.BEFORE}}">
        <countdown-timer role="timer" bgcolor="#00BCD4" date="{{date}}"
            easeintime="490" waittime="100" easeouttime="400"
            value="{{countdownValue}}" autoStart fit
            aria-label="{{countdownValue.days}} days, {{countdownValue.hours}} hours, {{countdownValue.minutes}} minutes, {{countdownValue.seconds}} seconds, until Google I/O">
        </countdown-timer>
      </template>

    </div>

  </template>
  <script>
  Polymer({

    _MODES: {LIVE: 'live', BEFORE: 'before', AFTER: 'after'},

    publish: {
      /**
       * The target date for the event. Should be specified in ISO 8601
       * format, e.g. 'May 28 2015 09:30:00 GMT-0700 (PDT)'.
       *
       * @attribute date
       * @type string
       * @default 'May 28 2015 09:30:00 GMT-0700 (PDT)'
       */
      date: 'May 28 2015 09:30:00 GMT-0700 (PDT)',

      /**
       * The mode of operation for the live embed. 'before' is before the event
       * starts (e.g. before `date`) and a countdown is shown leading up to the
       * event. 'live' signifies the event has already started and the live
       * stream video mode should be shown. 'after' is after the event.
       *
       * @attribute mode
       * @type string
       * @default null
       */
      mode: {
        value: '', reflect: true
      },

      /**
       * If in live mode, the FAB is open when true.
       *
       * @property openWidget
       * @type bool
       * @default false
       */
      openWidget: false,

      /**
       * The selected nav tab.
       *
       * @property selectedTab
       * @type string
       * @default 'live'
       */
      selectedTab: 'live',

      /**
       * The list of schedule sessions.
       *
       * @property sessions
       * @type array
       * @default []
       */
      sessions: null,

      /**
       * User's list of saved sessions.
       *
       * @attribute userSessions
       * @type array
       * @default []
       */
      userSessions: null,

      /**
       * Speaker info.
       *
       * @property speakers
       * @type object
       * @default {}
       */
      speakers: null,

      /**
       * Current day to display schedule information for. This calculated from
       * the `date` property. For example, "May 28 2015 09:00:00 GMT-0700 (PDT)"
       * would be 1.
       *
       * @property currentDay
       * @type number
       * @default 1
       */
      currentDay: null,

      /**
       * Whether fetching user data is in progress.
       *
       * @attribute fetchingUserData
       * @type Boolean
       * @default false
       */
      fetchingUserData: false,
    },

  eventDelegates: {
    'dblclick': 'toggleVideo'
  },

    created: function() {
      this.sessions = [];
      this.userSessions = [];
      this.speakers = {};
    },

    // attached: function() {
    //   var now = new Date();
    //   var eventStart = new Date(this.date);
    //   if (now > eventStart) {
    //     this.mode = this._MODES.LIVE;
    //   } else {
    //     this.mode = this._MODES.BEFORE;
    //   }
    // },

    dateChanged: function() {
      this.day1Start = moment(this.date);
      this.day1End = moment(this.day1Start).hours(17);
      this.day2Start = moment(this.day1Start).add(1, 'days');
      this.day2End = moment(this.day2Start).hours(17);

      // If we're before the start day of I/O, set current day to the start day
      // of I/O. Otherwise, set it to the current day of the show.
      var today = moment();
      if (today < this.day1Start) {
        this.currentDay = parseInt(this.day1Start.format('D'));
        this.mode = this._MODES.BEFORE;
      } else if (today > this.day2End) {
        this.currentDay = parseInt(this.day2End.format('D')); // max out on day 2.
        this.mode = this._MODES.AFTER;
      } else {
        this.currentDay = parseInt(today.format('D'));
        this.mode = this._MODES.LIVE;
      }

      // May 27 -> 1, May 28 -> 1, May 29 -> 2
      this.dayView = this.currentDay % parseInt(this.day1Start.format('D')) + 1;
    },

    openWidgetChanged: function() {
      this.$.livewidget.classList.toggle('open', this.openWidget);
      this.$.livewidget.classList.add('transitioning');
    },

    modeChanged: function() {
      this.fire('io-live-mode', {mode: this.mode});
    },

toggleVideo: function(e, detail, sender) {
  this.mode = this._MODES.LIVE;
},

    onFabTransition: function(e, detail, sender) {
      e.stopPropagation();
      sender.classList.remove('transitioning');
      if (!this.openWidget) {
        this.$.schedfab.style.visibility = 'visible';
      }
    },

    onFabClick: function(e, detail, sender) {
      e.stopPropagation();
      this.$.schedfab.style.visibility = 'hidden';
      this.openWidget = true;
    },

    closeFab: function(e, detail, sender) {
      e && e.stopPropagation();
      this.openWidget = false;
    },

    speakerIdsToNameString: function(speakers) {
      if (!speakers) {
        return '';
      }
      return speakers.map(function(speakerId) {
        return this.speakers[speakerId].name;
      }.bind(this)).join(', ');
    },

    filterLiveSessionsByDay: function(sessions, day) {
      return sessions.filter(function(session) {
        return session.day === day && session.isLivestream;
      });
    }

  });
  </script>
</polymer-element>
