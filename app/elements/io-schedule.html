<!--
Copyright 2015 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/core-label/core-label.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">

<!--
The `<io-schedule>` element renders a schedule for a given day(s).

@element io-schedule
-->
<polymer-element name="io-schedule">
  <template>
    <link rel="stylesheet" href="io-schedule.css">
    <link rel="stylesheet" href="../styles/pages/schedule.css">
    <div class="card__container sidebyside" layout horizontal>
      <div flex layout vertical>
        <template repeat="{{timeBlock in timeBlocks_}}">
          <div class="card day-title" hidden?="{{!timeBlock.dayStart || day}}">
            Day {{timeBlock.dayStart}}
          </div>
          <div class="card" hidden?="{{timeBlock.isEmpty || timeBlock.day !== day}}">
            <div class="card-content">
              <h4>{{timeBlock.name}}</h4>
            </div>
            <div class="card-content schedule-rows" layout horizontal>
              <template repeat="{{sessionId in sessionsIndex_}}">
                <div layout horizontal hidden?="{{session[sessionId].hide || sessions[sessionId].day !== timeBlock.day || sessions[sessionId].block !== timeBlock.name}}">
                  <paper-radio-button></paper-radio-button>
                  <div layout vertical flex>
                    <span class="schedule-title" auto-vertical flex
                        data-session-id="{{sessionId}}"
                        on-click="{{selectSession}}">
                      {{sessions[sessionId].title}}
                    </span>
                    <span class="schedule-time" auto-vertical flex two>
                      {{sessions[sessionId].start}} :
                      {{sessions[sessionId].end}}
                    </span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>

      <div class="card__container" layout vertical>
        <div class="card js-experiment-visualizer">
          <div class="card-content">
            <h4>Filters</h4>
          </div>
          <div class="card-content">
            <div id="filters">
              <div class="filter-rows filter-section">
                <template repeat="{{theme in sessionThemes}}">
                  <core-label center horizontal layout>
                    <div flex>{{theme}}</div>
                    <paper-checkbox on-change="{{applyFilter}}"
                        checked?="{{isFilterSelected(theme)}}"
                        name="{{theme}}" for></paper-checkbox>
                  </core-label>
                </template>
              </div>
              <div class="filter-rows filter-section">
                <template repeat="{{type in sessionTypes}}">
                  <core-label center horizontal layout>
                    <div flex>{{type}}</div>
                    <paper-checkbox on-change="{{applyFilter}}"
                        checked?="{{isFilterSelected(type)}}"
                        name="{{type}}" for></paper-checkbox>
                  </core-label>
                </template>
              </div>
              <div class="filter-rows filter-section">
                <core-label center horizontal layout>
                  <div flex>Live Streamed</div>
                  <paper-checkbox on-change="{{applyFilter}}"
                      checked?="{{isFilterSelected('Live Streamed')}}"
                      name="Live Streamed" for></paper-checkbox>
                </core-label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
  (function() {

    // TODO: Remove dummy data once this
    // https://github.com/GoogleChrome/ioweb2015/pull/923/files lands.
    var sessions = {
      "dc44916c-48e7-e311-b297-00155d5066d7":
      {
        "id": "bb8bf02d-3afd-e311-903f-00155d5066d7",
        "title": "Introduction to Classroom",
        "description": "Come by the School Sandbox Teaching Theater",
        "day": 2,
        "block": "10 AM",
        "start": "10:30 AM",
        "end": "11:00 AM",
        "startTimestamp": "2014-06-25T10:30:00Z",
        "endTimestamp": "2014-06-25T11:00:00Z",
        "speakers": ["speaker-id-1", "speaker-id-2"],
        "room": "RoomName 42",
        "photoUrl": "https://golang.org/doc/gopher/gopherbw.png",
        "youtubeUrl": "https://youtu.be/YCUZ01yFtsM",
        "isLivestream": false,
        "filters": {
          "Live Streamed": false,
          "Develop & Design": true
        }
      },
      "bb8bf02d-3afd-e311-903f-00155d5066d7vv":{
        "id": "bb8bf02d-3afdasd1-903f-00155d5066d7",
        "title": "Gopher rules",
        "description": "Meet the gopher and learn from the best",
        "day": 1,
        "block": "11 AM",
        "start": "11:30 AM",
        "end": "12:00 AM",
        "startTimestamp": "2014-06-24T11:30:00Z",
        "endTimestamp": "2014-06-24T12:00:00Z",
        "speakers": ["speaker-id-1", "speaker-id-2"],
        "room": "RoomName 42",
        "photoUrl": "https://golang.org/doc/gopher/gopherbw.png",
        "youtubeUrl": "https://youtu.be/YCUZ01yFtsM",
        "isLivestream": false,
        "filters": {
          "Live Streamed": true,
          "Develop & Design": true
        }
      },
      "bb8bf02d-3afd-e311-903f-00155d5066d7nn":{
        "id": "bb8bf0aa-3afdasd1-903f-00155d5066d7",
        "title": "Gopher rules again",
        "description": "Meet the gopher and learn from the best",
        "day": 1,
        "block": "12 PM",
        "start": "12:30 AM",
        "end": "13:00 AM",
        "startTimestamp": "2014-06-24T12:30:00Z",
        "endTimestamp": "2014-06-24T13:00:00Z",
        "speakers": ["speaker-id-1", "speaker-id-2"],
        "room": "RoomName 42",
        "photoUrl": "https://golang.org/doc/gopher/gopherbw.png",
        "youtubeUrl": "https://youtu.be/YCUZ01yFtsM",
        "isLivestream": false,
        "filters": {
          "Live Streamed": true,
          "Engage & Earn": true
        }
      }
    };

    var timeBlocks = [];
    var timeBlocksIndex = {};

    function populateTimeBlocks() {
      var hours = ['10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM'];
      for (var i = 1; i < 3; i++) {
        for (var j = 0; j < hours.length; j++) {
          var timeBlock = {
            name: hours[j],
            day: i,
            isEmpty: true
          };
          if (j === 0) {
            timeBlock['dayStart'] = i;
          }
          timeBlocks.push(timeBlock);
          var timeBlockId = i + hours[j];
          timeBlocksIndex[timeBlockId] = timeBlocks.length - 1;
        }
      }
    }
    populateTimeBlocks();


    Polymer({

      publish: {
        /**
         * The data about scheduled I/O sessions.
         *
         * @attribute sessions
         * @type array
         */
        sessions: sessions,

        /**
         * Optional day to filter the sessions, e.g. 'day1'.
         *
         * @attribute day
         * @type number
         * @default ''
         */
        day: null,

        /**
         * Array of session theme names.
         *
         * @property sessionThemes
         * @type array
         * @default []
         */
        sessionThemes: [],

        /**
         * Array of session types.
         *
         * @property sessionTypes
         * @type array
         * @default []
         */
        sessionTypes: [],

        /**
         * Array of applied filters.
         *
         * @property filters
         * @type array
         * @default []
         */
        filters: [],

        /**
         * Array of scheduled sessions.
         *
         * @property sessions.
         * @type array
         * @default []
         */
        sessions: []
      },

      timeBlocks_: timeBlocks,

      timeBlocksIndex_: timeBlocksIndex,

      sessionsIndex_: null,

      ready: function() {
        // TODO: Remove when dummy data no longer needed.
        this.sessions = sessions;
      },

      sessionsChanged: function() {
        this.sessionsIndex_ = Object.keys(this.sessions);
      },

      isFilterSelected: function(filterName) {
        return this.filters.indexOf(filterName) > -1;
      },

      applyFilter: function(e) {
        var filterName = e.target.getAttribute('name');
        var filterIndex = this.filters.indexOf(filterName);
        if (e.target.checked && filterIndex < 0) {
          this.filters.push(filterName);
        } else if (!e.target.checked && filterIndex > -1) {
          this.filters.splice(filterIndex, 1);
        }
      },

      filtersChanged: function() {
        for (var i = 0; i < this.sessions.length; i++) {
          sessions[i].hide = !this.matchesFilters(sessions[i]);
        }
        this.checkEmptyBlocks();
        IOWA.History.pushState({fromHashChange: true}, '', [
            window.location.origin,
            window.location.pathname,
            '?filters=' + encodeURIComponent(this.filters.join(',')),
            window.location.hash
        ].join(''));
      },

      matchesFilters: function(session) {
        if (!this.filters.length) {
          return true;
        }
        for (var i = 0; i < this.filters.length; i++) {
          if (session.filters[this.filters[i]]) {
            return true;
          }
        }
        return false;
      },

      checkEmptyBlocks: function() {
        for (var i = 0; i < this.sessionsIndex_.length; i++) {
          var session = this.sessions[this.sessionsIndex_[i]];
          var block = session.day + session.block;
          if (this.timeBlocks_[this.timeBlocksIndex_[block]]) {
            var isEmpty = !this.matchesFilters(session);
            this.timeBlocks_[this.timeBlocksIndex_[block]].isEmpty = isEmpty;
          }
        }
      },

      selectSession: function(e) {
        IOWA.Elements.Template.openSession(
            e.target.getAttribute('data-session-id'));
      }

    });

  })();
  </script>
</polymer-element>
